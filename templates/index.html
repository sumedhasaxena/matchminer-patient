<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Data</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 0;
        }
        .banner {
            background-color: #ffffff;
            padding: 15px 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        .banner img {
            height: 80px;
            width: auto;
        }
        .content {
            margin: 40px;
        }
        form { 
            max-width: 800px; 
            margin: auto; 
        }
        .form-table {
            width: 100%;
            min-width: 1000px;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .form-table td {
            padding: 8px 0;
            vertical-align: middle;
        }
        .form-table td:first-child {
            width: 40%;
            padding-right: 15px;
        }
        .form-table td:last-child {
            width: 60%;
        }
        label {
            display: block;
            white-space: normal;
            word-wrap: break-word;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            max-width: 300px;
            box-sizing: border-box;
        }
        button { 
            margin-top: 15px; 
            padding: 10px 20px; 
        }
        .flash { 
            color: #2c5282;
            margin: 20px auto;
            padding: 15px;
            border-radius: 4px;
            background-color: #ebf8ff;
            border: 1px solid #bee3f8;
            text-align: center;
            max-width: 800px;
        }
        .flash .patient-id {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }
        .flash .reference-note {
            font-size: 0.9em;
            color: #4a5568;
            display: block;
        }
        h2 { 
            text-align: center; 
            margin-top: 0;
        }
        h3 { 
            text-align: left; 
        }
        .section { 
            margin-bottom: 30px; 
        }
        .required { 
            color: red; 
            margin-right: 3px; 
        }
        .conditional-field { 
            display: none; 
        }
        .file-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .remove-file {
            color: #e53e3e;
            cursor: pointer;
            margin-left: 10px;
            font-size: 18px;
            font-weight: bold;
            padding: 0 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .remove-file:hover {
            background-color: #fed7d7;
        }
        .btn {
            background-color: #4a5568;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2d3748;
        }
        input[type="file"] {
            display: none;
        }
        .file-upload-btn {
            background-color: #4a5568;
            color: white;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        .file-upload-btn:hover {
            background-color: #2d3748;
        }
        .submit-btn {
            background-color: #2b6cb0;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            display: block;
            margin: 30px auto;
            min-width: 200px;
        }
        .submit-btn:hover {
            background-color: #2c5282;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .submit-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .message {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
            display: none;
        }
        .message.info {
            background-color: #ebf8ff;
            color: #2c5282;
            border: 1px solid #bee3f8;
        }
        .message.error {
            background-color: #fff5f5;
            color: #c53030;
            border: 1px solid #feb2b2;
        }
        .diagnosis-container {
            display: block;
            gap: 0;
            align-items: flex-start;
            margin: 0;
        }
        .diagnosis-hierarchy {
            margin: 0 0 0 20px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            display: none;
            font-size: 13px;
            min-width: 300px;
            max-width: 350px;
            word-break: break-word;
        }
        .diagnosis-select {
            flex: 1;
        }
        .toggle-hierarchy {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 10px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #4a5568;
        }
        .toggle-hierarchy:hover {
            background-color: #edf2f7;
        }
        .toggle-hierarchy .arrow {
            transition: transform 0.3s ease;
        }
        .toggle-hierarchy.expanded .arrow {
            transform: rotate(180deg);
        }
        .hierarchy-content {
            display: none;
            margin-top: 10px;
        }
        .hierarchy-content.expanded {
            display: block;
        }
        #diagnosis-specific-dropdowns table.form-table {
            width: 100%;
            table-layout: auto;
            min-width: 0;
        }
        #diagnosis-specific-dropdowns {
            max-width: 600px;
            overflow-x: auto;
        }
        .advanced-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            color: #2b6cb0;
            margin-bottom: 10px;
            user-select: none;
            padding: 8px;
            border-radius: 4px;
        }
        .advanced-toggle:hover {
        background-color: #edf2f7;
        }
        .advanced-caret {
            display: inline-block;
            transition: transform 0.3s;
            margin-right: 8px;
            font-size: 20px;
        }
        .advanced-caret.expanded {
            transform: rotate(90deg);
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2b6cb0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 18px;
            color: #2b6cb0;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .progress-container {
            width: 90%;
            max-width: 700px;
            background: white;
            border-radius: 8px;
            padding: 32px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-item.pending {
            color: #718096;
        }

        .progress-item.running {
            color: #2b6cb0;
            background: #ebf8ff;
        }

        .progress-item.completed {
            color: #38a169;
            background: #f0fff4;
        }

        .progress-item.error {
            color: #e53e3e;
            background: #fff5f5;
        }

        .progress-status {
            font-weight: 500;
        }

        .progress-message {
            font-size: 14px;
            color: #4a5568;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ellipsis {
            font-size: 1.5em;
            font-weight: bold;
            letter-spacing: 2px;
            vertical-align: middle;
            min-width: 2em;
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- Add loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing your request...</div>
        <div class="progress-container">
            <div id="diagnosisProgress" class="progress-item pending">
                <span class="progress-status">Diagnosis Lookup</span>
                <span class="progress-message">Trying to get the closest oncotree match for the entered diagnosis&nbsp;<span class="ellipsis"></span></span>
            </div>
            <div id="additionalInfoProgress" class="progress-item pending">
                <span class="progress-status">Additional Information</span>
                <span class="progress-message">Extracting additional information&nbsp;<span class="ellipsis"></span></span>
            </div>
            <div id="ocrProgress" class="progress-item pending">
                <span class="progress-status">Image Processing</span>
                <span class="progress-message">Parsing any uploaded image(s) to extract genomic data&nbsp;<span class="ellipsis"></span></span>
            </div>
        </div>
    </div>
    <div class="banner">
        <img src="{{ url_for('static', filename='images/matchminer_hkumed_logo.png') }}" alt="MatchMiner HKUMed Logo">
    </div>
    <div class="content">
        <h2>Patient Data</h2>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="flash">
                <span class="patient-id">{{ messages[0].split('\n')[0] }}</span>
                <span class="reference-note">{{ messages[0].split('\n')[1] }}</span>
            </div>
          {% endif %}
        {% endwith %}
        <form method="post" enctype="multipart/form-data">
            <div class="section">
                <h3>Clinical Data</h3>
                <table class="form-table">
                    <tr>
                        <td><label for="gender"><span class="required">*</span>Gender:</label></td>
                        <td colspan="2">
                            <select id="gender" name="gender" required>
                                <option value="">Select</option>
                                <option value="Male" {% if form_data.gender == 'Male' %}selected{% endif %}>Male</option>
                                <option value="Female" {% if form_data.gender == 'Female' %}selected{% endif %}>Female</option>
                                <option value="Other" {% if form_data.gender == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <td><label for="age"><span class="required">*</span>Age:</label></td>
                        <td colspan="2">
                            <input type="number" id="age" name="age" min="0" value="{{ form_data.age or '' }}" required>
                        </td>
                    </tr>

                    <tr>
                        <td><label for="report_date"><span class="required">*</span>Report Date:</label></td>
                        <td colspan="2">
                            <input type="date" id="report_date" name="report_date" value="{{ form_data.report_date or '' }}" required>
                        </td>
                    </tr>

                    <tr>
                        <td><label for="diagnosis_free_text">Diagnosis (free text):</label></td>
                        <td colspan="2">
                            <input type="text" id="diagnosis_free_text" name="diagnosis_free_text" value="{{ free_text_diagnosis or '' }}">
                        </td>
                    </tr>
                    <!-- <tr>
                        <td colspan="3">
                            <button type="button" class="btn btn-secondary" onclick="toggleAdvancedDiagnosis()" style="margin-bottom: 10px;">Show Advanced Options</button>
                        </td>
                    </tr> -->
                    <tr>
                        <td colspan="3">
                            <div class="advanced-toggle" onclick="toggleAdvancedDiagnosis()">
                                <span id="advanced-caret" class="advanced-caret">&#9654;</span>
                                <span>Advanced Diagnosis Options</span>
                            </div>
                        </td>
                    </tr>
                    <tbody id="advanced-diagnosis-section" style="display: none;">
                        <tr>
                            <td><label for="diagnosis_level1">Diagnosis Level 1:</label></td>
                            <td style="width: 260px;">
                                <select id="diagnosis_level1" name="diagnosis_level1" onchange="updateDiagnosisLevel2();clearAdditionalFields()">
                                    <option value="">Select Level 1</option>
                                    {% for level1 in level1_list %}
                                    <option value="{{ level1 }}" {% if diagnosis_result.level1 == level1 %}selected{% endif %}>{{ level1 }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td style="width: 1px; max-width: 350px; vertical-align: top;">
                                <div id="diagnosis-hierarchy" class="diagnosis-hierarchy">
                                    <button type="button" class="toggle-hierarchy" onclick="toggleHierarchy()">
                                        <span>Sub-levels of selected diagnosis</span>
                                        <span class="arrow">▼</span>
                                    </button>
                                    <div class="hierarchy-content">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Level 2</th>
                                                    <th>Level 3</th>
                                                </tr>
                                            </thead>
                                            <tbody id="diagnosis-hierarchy-body">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="diagnosis_level2">Diagnosis Level 2:</label></td>
                            <td colspan="2">
                                <select id="diagnosis_level2" name="diagnosis_level2" onchange="updateDiagnosisLevel3()">
                                    <option value="">Select Level 2</option>
                                    {% if diagnosis_result.level2 %}
                                    <option value="{{ diagnosis_result.level2 }}" selected>{{ diagnosis_result.level2 }}</option>
                                    {% endif %}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td><label for="diagnosis_level3">Diagnosis Level 3:</label></td>
                            <td colspan="2">
                                <select id="diagnosis_level3" name="diagnosis_level3">
                                    <option value="">Select Level 3 (Optional)</option>
                                    {% if diagnosis_result.level3 %}
                                    <option value="{{ diagnosis_result.level3 }}" selected>{{ diagnosis_result.level3 }}</option>
                                    {% endif %}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <button type="button" class="btn btn-secondary" onclick="showAdditionalFields()">
                                    Display Additional Fields
                                </button>
                                <div id="no-fields-message" class="message info" style="display: none;">
                                    No additional fields available for this diagnosis
                                </div>
                            </td>
                        </tr>
                        <tr id="diagnosis-specific-dropdowns-row" style="display: none;"></tr>
                    </tbody>
                </table>
            </div>
            <div class="section">
                <h3>Additional Information</h3>
                <table class="form-table">
                    <tr>
                        <td><label for="description">Description:</label></td>
                        <td colspan="2">
                            <textarea id="description" name="description" style="height: 120px;">{{ form_data.description or '' }}</textarea>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="section">
                <h3>Genomic Data</h3>
                <table class="form-table">
                    <tr>
                        <td><label for="genomic_images">Upload Genomic Data Images:</label></td>
                        <td>
                            <label for="genomic_images" class="file-upload-btn">Choose Files</label>
                            <input type="file" id="genomic_images" name="genomic_images" accept="image/*" multiple onchange="updateFileList(this)">
                            <div id="fileList" class="file-list">
                                {% if form_data and form_data.genomic_images %}
                                    {% for file in form_data.genomic_images %}
                                    <div class="file-item">
                                        <span>{{ file }}</span>
                                        <span class="remove-file" onclick="removeFileFromList(this)">×</span>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div style="display: flex; justify-content: center; gap: 16px;">                
                <button type="button" class="submit-btn" onclick="resetForm()">Reset</button>
                <button type="submit" class="submit-btn">Submit</button>
            </div>
        </form>

        <script>
            function toggleHierarchy() {
                const button = document.querySelector('.toggle-hierarchy');
                const content = document.querySelector('.hierarchy-content');
                button.classList.toggle('expanded');
                content.classList.toggle('expanded');
            }
            
            function clearAdditionalFields() {
                document.querySelectorAll('.dynamic-diagnosis-row').forEach(row => row.remove());
                document.getElementById('diagnosis-specific-dropdowns-row').style.display = 'none';
            }

            function updateDiagnosisLevel2() {
                const level1 = document.getElementById('diagnosis_level1').value;
                const level2Select = document.getElementById('diagnosis_level2');
                const level3Select = document.getElementById('diagnosis_level3');
                const hierarchyDiv = document.getElementById('diagnosis-hierarchy');
                const hierarchyBody = document.getElementById('diagnosis-hierarchy-body');
                const toggleButton = document.querySelector('.toggle-hierarchy');
                const toggleButtonLabel = toggleButton.querySelector('span');
                const content = document.querySelector('.hierarchy-content');
                
                // Set dynamic button label
                if (level1) {
                    toggleButtonLabel.textContent = `Diagnosis tree for ${level1}`;
                } else {
                    toggleButtonLabel.textContent = 'Diagnosis tree';
                }
                
                // Reset level2 and level3
                level2Select.innerHTML = '<option value="">Select Level 2</option>';
                level3Select.innerHTML = '<option value="">Select Level 3</option>';
                
                if (level1) {
                    // Fetch and populate the hierarchy table
                    fetch(`/get_level2/${encodeURIComponent(level1)}`)
                        .then(response => response.json())
                        .then(data => {
                            // Populate level2 dropdown
                            data.forEach(level2 => {
                                const option = document.createElement('option');
                                option.value = level2;
                                option.textContent = level2;
                                level2Select.appendChild(option);
                            });

                            // Show hierarchy container
                            hierarchyDiv.style.display = 'block';
                            // Clear hierarchy table body ONCE here
                            hierarchyBody.innerHTML = '';
                            
                            // Reset toggle state
                            toggleButton.classList.remove('expanded');
                            content.classList.remove('expanded');

                            // For each level2, fetch its level3 options
                            const level2Promises = data.map(level2 => 
                                fetch(`/get_level3/${encodeURIComponent(level2)}`)
                                    .then(response => response.json())
                                    .then(level3Data => ({
                                        level2,
                                        level3Data
                                    }))
                            );

                            Promise.all(level2Promises)
                                .then(results => {
                                    // Only append rows after clearing, and do it once
                                    results.forEach(({level2, level3Data}) => {
                                        const row = document.createElement('tr');
                                        
                                        const level2Cell = document.createElement('td');
                                        level2Cell.textContent = level2;
                                        row.appendChild(level2Cell);
                                        
                                        const level3Cell = document.createElement('td');
                                        if (level3Data.length > 0) {
                                            level3Cell.textContent = level3Data.join(', ');
                                        } else {
                                            level3Cell.textContent = '-';
                                        }
                                        row.appendChild(level3Cell);
                                        
                                        hierarchyBody.appendChild(row);
                                    });
                                })
                                .catch(error => {
                                    console.error('Error loading level 3 data:', error);
                                    hierarchyBody.innerHTML = '<tr><td colspan="2">Error loading diagnosis hierarchy</td></tr>';
                                });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            hierarchyDiv.style.display = 'none';
                        });
                } else {
                    hierarchyDiv.style.display = 'none';
                    // Also clear hierarchy table body if no level1 selected
                    hierarchyBody.innerHTML = '';
                }
            }

            function updateDiagnosisLevel3() {
                const level2 = document.getElementById('diagnosis_level2').value;
                const level3Select = document.getElementById('diagnosis_level3');
                
                // Reset level3
                level3Select.innerHTML = '<option value="">Select Level 3</option>';
                
                if (level2) {
                    fetch(`/get_level3/${encodeURIComponent(level2)}`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(level3 => {
                                const option = document.createElement('option');
                                option.value = level3;
                                option.textContent = level3;
                                level3Select.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error:', error));
                }
            }

            function showAdditionalFields() {
                const level1 = document.getElementById('diagnosis_level1').value;
                const level2 = document.getElementById('diagnosis_level2').value;
                const level3 = document.getElementById('diagnosis_level3').value;
                
                // Remove any existing dynamic dropdown rows
                document.querySelectorAll('.dynamic-diagnosis-row').forEach(row => row.remove());
                const insertAfter = document.getElementById('diagnosis-specific-dropdowns-row');
                let lastInserted = insertAfter;
                
                // Hide the message initially
                const messageDiv = document.getElementById('no-fields-message');
                messageDiv.style.display = 'none';
                
                // Build diagnosis string based on available levels
                let diagnosis = '';
                if (level1) {
                    diagnosis = level1;
                    if (level2) {
                        diagnosis += ' > ' + level2;
                        if (level3) {
                            diagnosis += ' > ' + level3;
                        }
                    }
                }
                
                if (!diagnosis) {
                    messageDiv.textContent = 'Please select at least Level 1 diagnosis';
                    messageDiv.className = 'message error';
                    messageDiv.style.display = 'block';
                    return;
                }
                
                fetch(`/get_additional_diagnosis_dropdowns/${encodeURIComponent(diagnosis)}`)
                    .then(response => response.json())
                    .then(dropdowns => {
                        // All code that uses 'dropdowns' is inside this block
                        if (dropdowns.length > 0) {
                            dropdowns.forEach(dropdown => {
                                const dropdownRow = document.createElement('tr');
                                dropdownRow.classList.add('dynamic-diagnosis-row');
                                
                                const labelCell = document.createElement('td');
                                const label = document.createElement('label');
                                label.htmlFor = dropdown.name;
                                label.textContent = dropdown.label;
                                labelCell.appendChild(label);
                                
                                const selectCell = document.createElement('td');
                                selectCell.colSpan = 2;
                                const select = document.createElement('select');
                                select.className = 'form-control';
                                select.name = dropdown.name;
                                select.id = dropdown.name;
                                
                                // Add empty option
                                const emptyOption = document.createElement('option');
                                emptyOption.value = '';
                                emptyOption.textContent = 'Select ' + dropdown.label;
                                select.appendChild(emptyOption);
                                
                                // Add value options
                                dropdown.values.forEach(value => {
                                    const option = document.createElement('option');
                                    option.value = value;
                                    option.textContent = value;
                                    select.appendChild(option);
                                });
                                
                                selectCell.appendChild(select);
                                dropdownRow.appendChild(labelCell);
                                dropdownRow.appendChild(selectCell);
                                lastInserted.parentNode.insertBefore(dropdownRow, lastInserted.nextSibling);
                                lastInserted = dropdownRow;
                            });
                            document.getElementById('diagnosis-specific-dropdowns-row').style.display = '';
                        } else {
                            messageDiv.textContent = 'No additional fields available for this diagnosis';
                            messageDiv.className = 'message info';
                            messageDiv.style.display = 'block';
                            document.getElementById('diagnosis-specific-dropdowns-row').style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        messageDiv.textContent = 'Error loading additional fields';
                        messageDiv.className = 'message error';
                        messageDiv.style.display = 'block';
                    });
            }

            function initializeFileList() {
                const fileList = document.getElementById('fileList');
                const existingFiles = fileList.querySelectorAll('.file-item');
                if (existingFiles.length > 0) {
                    // If there are existing files, store them in a data attribute
                    const fileNames = Array.from(existingFiles).map(item => item.textContent.trim());
                    fileList.setAttribute('data-existing-files', JSON.stringify(fileNames));
                }
            }

            function updateFileList(input) {
                const fileList = document.getElementById('fileList');
                const existingFiles = JSON.parse(fileList.getAttribute('data-existing-files') || '[]');
                
                // Clear the file list
                fileList.innerHTML = '';
                
                // Add existing files back
                existingFiles.forEach(fileName => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `
                        <span>${fileName}</span>
                        <span class="remove-file" onclick="removeFileFromList(this)">×</span>
                    `;
                    fileList.appendChild(div);
                });

                // Add new files
                if (input.files.length > 0) {
                    Array.from(input.files).forEach(file => {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        div.innerHTML = `
                            <span>${file.name}</span>
                            <span class="remove-file" onclick="removeFileFromList(this)">×</span>
                        `;
                        fileList.appendChild(div);
                    });
                }

                // Update the data attribute with current files
                const currentFiles = Array.from(fileList.querySelectorAll('.file-item span:first-child'))
                    .map(span => span.textContent.trim());
                fileList.setAttribute('data-existing-files', JSON.stringify(currentFiles));
            }

            function removeFileFromList(button) {
                const fileItem = button.parentElement;
                const fileName = fileItem.querySelector('span:first-child').textContent.trim();
                const fileList = document.getElementById('fileList');
                
                // Remove the file item from the display
                fileItem.remove();
                
                // Update the data attribute
                const currentFiles = Array.from(fileList.querySelectorAll('.file-item span:first-child'))
                    .map(span => span.textContent.trim());
                fileList.setAttribute('data-existing-files', JSON.stringify(currentFiles));

                // If this was a newly added file (not from session), also remove it from the input
                const input = document.getElementById('genomic_images');
                if (input.files.length > 0) {
                    const dt = new DataTransfer();
                    Array.from(input.files).forEach(file => {
                        if (file.name !== fileName) {
                            dt.items.add(file);
                        }
                    });
                    input.files = dt.files;
                }
            }

            function resetForm() {
                const form = document.querySelector('form');
                form.reset();
                // Reset dynamic dropdowns
                updateDiagnosisLevel2();
                // Clear file list display
                document.getElementById('fileList').innerHTML = '';
                // Hide additional fields
                document.getElementById('diagnosis-specific-dropdowns-row').style.display = 'none';
                // Hide hierarchy
                const hierarchyDiv = document.getElementById('diagnosis-hierarchy');
                if (hierarchyDiv) hierarchyDiv.style.display = 'none';
                // Hide messages
                const messageDiv = document.getElementById('no-fields-message');
                if (messageDiv) messageDiv.style.display = 'none';
                // Hide patient ID flash banner
                const flashBanner = document.querySelector('.flash');
                if (flashBanner) flashBanner.style.display = 'none';
            }

            function toggleAdvancedDiagnosis() {
                const section = document.getElementById('advanced-diagnosis-section');
                const caret = document.getElementById('advanced-caret');
                const expanded = section.style.display !== 'none';
                section.style.display = expanded ? 'none' : '';
                if (caret) caret.classList.toggle('expanded', !expanded);
            }

           // Initialize form fields on page load
           document.addEventListener('DOMContentLoaded', updateDiagnosisLevel2);

            // Add form submission handler
            document.querySelector('form').addEventListener('submit', function(e) {
                const freeTextDiagnosis = document.getElementById('diagnosis_free_text').value;
                
                if (freeTextDiagnosis) {
                    // Show loading overlay
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    loadingOverlay.style.display = 'flex';
                    // Form will submit normally, overlay stays visible until redirect
                }
                // If no free text diagnosis, form submits normally without overlay
            });

            document.addEventListener('DOMContentLoaded', function() {
                function animateEllipsis(selector) {
                    var elements = document.querySelectorAll(selector);
                    var dots = ['', '.', '..', '...'];
                    var idx = 0;
                    setInterval(function() {
                        elements.forEach(function(el) {
                            el.textContent = dots[idx % dots.length];
                        });
                        idx++;
                    }, 500);
                }
                animateEllipsis('.ellipsis');
            });
        </script>
    </div>
</body>
</html> 